[gcode_macro PRINT_START]
gcode:
  # =============================================================================
  # TUNING VARIABLES - Modify these values to adjust macro behavior
  # =============================================================================
  
  # Temperature Settings
  {% set preheat_hotend_temp = 150 %}        # Hotend temp for QGL/meshing (prevents oozing)
  {% set heat_soak_threshold = 90 %}         # Bed temp threshold for heat soaking (°C)
  {% set qgl_hotend_temp = 150 %}            # Minimum hotend temp for gantry leveling
  
  # Movement & Positioning
  {% set safe_z_height = 15 %}               # Z height for safe moves (mm)
  {% set movement_speed = 18000 %}           # XY movement speed (mm/min)
  
  # Cartographer Touch Settings
  {% set touch_retries = 5 %}                # Number of touch probe retries
  {% set touch_tolerance = 0.025 %}          # Touch probe tolerance (mm)
  {% set touch_retract_speed = 35 %}         # Touch probe retract speed (mm/s)
  {% set touch_approach_speed = 8 %}         # Touch probe approach speed (mm/s)
  {% set touch_acceleration = 600 %}         # Touch probe acceleration (mm/s²)
  {% set touch_samples = 1 %}                # Number of touch samples per probe
  
  # Hotend Cooling Settings
  {% set cooling_fan_speed = 255 %}          # Part cooling fan speed for hotend cooling (0-255)
  
  # =============================================================================
  # PRINT START SEQUENCE - Main macro logic below
  # =============================================================================

  # Parse input parameters from slicer - these come from your slicer's start G-code
  {% set target_bed = params.BED|int %}              # Bed temperature from slicer (required)
  {% set target_extruder = params.EXTRUDER|int %}   # Hotend temperature from slicer (required)
  {% set target_chamber = params.CHAMBER|default("45")|int %}  # Chamber temp (optional, defaults to 45°C)
  
  # Calculate center positions for parking/waiting - uses your printer's actual bed size
  {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}  # X center (175mm on 350mm bed)
  {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}  # Y center (175mm on 350mm bed)

  # Clear any previous print state - essential for clean start
  CLEAR_PAUSE                             # Clear any pause state from previous print
  SET_GCODE_OFFSET Z=0                   # Reset any Z offset from previous print

  # Start bed heating immediately - longest heating process, so start early
  SET_DISPLAY_TEXT MSG="Starting bed heat: {target_bed}c"
  M140 S{target_bed}                     # Begin bed heating (non-blocking)
  LIGHTS_HEATING                         # Set LED status to heating

  # Home all axes - must be done before any movement commands
  SET_DISPLAY_TEXT MSG="Homing"
  G28                                    # Home X, Y, Z using sensorless homing + Cartographer
  G90                                    # Set to absolute positioning mode
  BED_MESH_CLEAR                         # Clear any existing bed mesh from memory

  # Check if hotend needs cooling - prevents oozing from hot nozzle
  {% if printer.extruder.temperature > preheat_hotend_temp %}
    SET_DISPLAY_TEXT MSG="Cooling hotend from {printer.extruder.temperature|round(1)}c to {preheat_hotend_temp}c"
    LIGHTS_COOLING                       # Switch to cool blue breathing effect
    M104 S{preheat_hotend_temp}          # Set target to preheat temp (will start cooling)
    M106 S{cooling_fan_speed}            # Turn on part cooling fan to help cool hotend
    M109 S{preheat_hotend_temp}          # Wait for hotend to cool to preheat temp
    M107                                 # Turn off part cooling fan after cooling
    LIGHTS_HEATING                       # Switch back to heating mode for next phase
  {% endif %}

  # Pre-heat hotend to QGL temperature - warm enough for thermal expansion, cool enough to prevent oozing
  SET_DISPLAY_TEXT MSG="Pre-heating hotend"
  M104 S{preheat_hotend_temp}            # Start hotend heating to preheat temp (non-blocking)

  # Move to center position for thermal stability
  SET_DISPLAY_TEXT MSG="Moving to center position"
  G1 X{x_wait} Y{y_wait} Z{safe_z_height} F{movement_speed}

  # Bed heating logic with heat soaking for high temps
  {% if target_bed > heat_soak_threshold %}
    # High temp materials (ABS, ASA, etc.) need heat soaking for thermal stability
    SET_DISPLAY_TEXT MSG="Heat soaking: {target_bed}c"
    M106 S255                            # Turn on part cooling fan at 100% for circulation
    M190 S{target_bed}                   # Wait for bed to reach target (blocking command)
  {% else %}
    # Low temp materials (PLA, PETG, TPU) don't need heat soaking
    SET_DISPLAY_TEXT MSG="Heating bed: {target_bed}c"
    M190 S{target_bed}                   # Wait for bed to reach target (blocking command)
  {% endif %}

  # Wait for hotend to reach QGL temperature - thermal expansion affects gantry level
  M109 S{qgl_hotend_temp}                # Wait for hotend to reach QGL temp (blocking command)

  # Move to center for gantry leveling - most stable position for QGL
  G1 X{x_wait} Y{y_wait} Z{safe_z_height} F{movement_speed}

  # Gantry leveling sequence - critical for first layer quality
  LIGHTS_BREATHE                          # Set LEDs to breathing pattern during leveling
  SET_DISPLAY_TEXT MSG="Leveling gantry"
  QUAD_GANTRY_LEVEL                      # Level the gantry using 4-point probing
  G28 Z                                  # Re-home Z after QGL to ensure accuracy

  # Quick nozzle clean after QGL probing
  SET_DISPLAY_TEXT MSG="Quick nozzle clean after QGL"
  CLEAN_NOZZLE_QUICK                     # 2 passes, no retract/prime - just remove debris

  # Adaptive bed meshing - only probe the area that will be printed
  SET_DISPLAY_TEXT MSG="Adaptive bed meshing"
  BED_MESH_CALIBRATE ADAPTIVE=1          # KAMP adaptive meshing - faster than full bed

  # Thorough nozzle clean after bed meshing
  SET_DISPLAY_TEXT MSG="Thorough nozzle clean"
  #CLEAN_NOZZLE #PASSES=6 RETRACT=true PRIME=true  # Thorough clean with retract/prime

  # Final heating phase - bring hotend up to printing temperature
  LIGHTS_HEATING                         # Resume heating LED status
  SET_DISPLAY_TEXT MSG="Final heating: {target_extruder}c"
  M104 S{target_extruder}                # Start heating to final temperature (non-blocking)
  G1 X{x_wait} Y{y_wait} Z{safe_z_height} F{movement_speed}  # Stay in center position
  M107                                   # Turn off part cooling fan after heat soak

  # Cartographer touch calibration - precise Z offset for perfect first layer
  SET_DISPLAY_TEXT MSG="Calibrating Z offset"
  CARTOGRAPHER_TOUCH RETRIES={touch_retries} TOLERANCE={touch_tolerance} RETRACT_SPEED={touch_retract_speed} SPEED={touch_approach_speed} ACCEL={touch_acceleration} SAMPLES={touch_samples}
  SET_DISPLAY_TEXT MSG="Heating hotend to 'target_extruder'"
  M109 S{target_extruder}                # Wait for final hotend temperature (blocking)

  # Purge sequence - prime the nozzle for perfect first extrusion
  SET_DISPLAY_TEXT MSG="Purging"
  LED_PROGRESS_BAR                        # Switch to solid white LEDs for printing phase
  G90                                    # Ensure absolute positioning mode
  LINE_PURGE                             # KAMP adaptive line purge - clears nozzle

  # Ready to print!
  SET_DISPLAY_TEXT MSG="Printing"        # Update display status