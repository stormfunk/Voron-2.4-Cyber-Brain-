[gcode_macro CLEAN_NOZZLE]
description: Clean nozzle on bed-mounted brush with configurable parameters
# =============================================================================
# DEFAULT VARIABLES - Adjust these to match your brush setup
# =============================================================================
variable_brush_x: 80              # X position of brush center
variable_brush_y: 349              # Y position of brush (back of bed)
variable_brush_z: 1.0              # Z height when cleaning (nozzle touching brush)
variable_approach_z: 10            # Safe Z height when moving to brush
variable_safe_z: 15                # Safe Z height for general moves
variable_brush_width: 34           # Total width of brush cleaning area (mm)
variable_passes: 5                 # Number of back-and-forth cleaning passes
variable_clean_speed: 8000         # Speed during cleaning moves (mm/min)
variable_travel_speed: 6000        # Speed for travel moves (mm/min)
variable_z_speed: 600              # Speed for Z moves (mm/min)
variable_min_temp: 150             # Minimum hotend temp to perform cleaning (째C)
variable_dwell_time: 1000          # Dwell time on brush after cleaning (ms)
variable_retract_before: True      # Retract filament before cleaning
variable_retract_amount: 2.0       # Amount to retract (mm)
variable_prime_after: True         # Prime after cleaning
variable_prime_amount: 1.9         # Amount to prime (mm)

gcode:
    # Parse parameters - use defaults if not specified
    {% set brush_x = params.X|default(printer["gcode_macro CLEAN_NOZZLE"].brush_x)|float %}
    {% set brush_y = params.Y|default(printer["gcode_macro CLEAN_NOZZLE"].brush_y)|float %}
    {% set brush_z = params.Z|default(printer["gcode_macro CLEAN_NOZZLE"].brush_z)|float %}
    {% set approach_z = params.APPROACH_Z|default(printer["gcode_macro CLEAN_NOZZLE"].approach_z)|float %}
    {% set safe_z = params.SAFE_Z|default(printer["gcode_macro CLEAN_NOZZLE"].safe_z)|float %}
    {% set brush_width = params.WIDTH|default(printer["gcode_macro CLEAN_NOZZLE"].brush_width)|float %}
    {% set passes = params.PASSES|default(printer["gcode_macro CLEAN_NOZZLE"].passes)|int %}
    {% set clean_speed = params.CLEAN_SPEED|default(printer["gcode_macro CLEAN_NOZZLE"].clean_speed)|int %}
    {% set travel_speed = params.TRAVEL_SPEED|default(printer["gcode_macro CLEAN_NOZZLE"].travel_speed)|int %}
    {% set z_speed = params.Z_SPEED|default(printer["gcode_macro CLEAN_NOZZLE"].z_speed)|int %}
    {% set min_temp = params.MIN_TEMP|default(printer["gcode_macro CLEAN_NOZZLE"].min_temp)|float %}
    {% set dwell_time = params.DWELL|default(printer["gcode_macro CLEAN_NOZZLE"].dwell_time)|int %}
    {% set retract_before = params.RETRACT|default(printer["gcode_macro CLEAN_NOZZLE"].retract_before)|lower == 'true' %}
    {% set retract_amount = params.RETRACT_AMOUNT|default(printer["gcode_macro CLEAN_NOZZLE"].retract_amount)|float %}
    {% set prime_after = params.PRIME|default(printer["gcode_macro CLEAN_NOZZLE"].prime_after)|lower == 'true' %}
    {% set prime_amount = params.PRIME_AMOUNT|default(printer["gcode_macro CLEAN_NOZZLE"].prime_amount)|float %}
    
    # Calculate brush extents
    {% set brush_left = brush_x - (brush_width / 2) %}
    {% set brush_right = brush_x + (brush_width / 2) %}
    
    # Auto-home if needed
    {% if "xyz" not in printer.toolhead.homed_axes %}
        SET_DISPLAY_TEXT MSG="Right, let me get that sorted"
        G28
    {% endif %}
    
    {% if printer.extruder.temperature < min_temp %}
        SET_DISPLAY_TEXT MSG="Hotend too cold ({printer.extruder.temperature|round(1)}째C) - skipping nozzle clean"
        { action_respond_info("Hotend temperature %.1f째C is below minimum %.1f째C - skipping nozzle cleaning" % (printer.extruder.temperature, min_temp)) }
    {% else %}
        SET_DISPLAY_TEXT MSG="Cleaning nozzle - {passes} passes"
        
        # Save current state
        SAVE_GCODE_STATE NAME=CLEAN_NOZZLE_STATE
        G90  # Absolute positioning
        
        # Optional retraction before cleaning
        {% if retract_before %}
            G91
            G1 E-{retract_amount} F300
            G90
        {% endif %}
        
        # Move to safe Z height first
        G1 Z{safe_z} F{z_speed}
        
        # Move to brush position at approach height
        G1 X{brush_x} Y{brush_y} Z{approach_z} F{travel_speed}
        
        # Lower to cleaning height
        G1 Z{brush_z} F{z_speed}
        
        # Start the tickling process
        SET_DISPLAY_TEXT MSG="Tickling the nozzle clean"
        
        # Perform cleaning passes
        {% for pass in range(passes) %}
            {% if pass % 2 == 0 %}
                # Even passes: left to right
                G1 X{brush_left} F{clean_speed}
                G1 X{brush_right} F{clean_speed}
            {% else %}
                # Odd passes: right to left  
                G1 X{brush_right} F{clean_speed}
                G1 X{brush_left} F{clean_speed}
            {% endif %}
        {% endfor %}
        
        # Return to brush center and dwell
        G1 X{brush_x} F{clean_speed}
        {% if dwell_time > 0 %}
            G4 P{dwell_time}
        {% endif %}
        
        # Lift to approach height
        G1 Z{approach_z} F{z_speed}
        
        # Optional priming after cleaning
        {% if prime_after %}
            G91
            G1 E{prime_amount} F300
            G90
        {% endif %}
        
        # Restore previous state
        RESTORE_GCODE_STATE NAME=CLEAN_NOZZLE_STATE
        SET_DISPLAY_TEXT MSG="Nozzle cleaning complete"
    {% endif %}

# =============================================================================
# CONVENIENCE MACROS - Pre-configured cleaning routines
# =============================================================================

[gcode_macro CLEAN_NOZZLE_QUICK]
description: Quick nozzle clean (2 passes, no retract/prime)
gcode:
    CLEAN_NOZZLE PASSES=2 RETRACT=false PRIME=false DWELL=500

[gcode_macro CLEAN_NOZZLE_THOROUGH] 
description: Thorough nozzle clean (8 passes, with retract/prime)
gcode:
    CLEAN_NOZZLE PASSES=8 RETRACT=true PRIME=true DWELL=2000 CLEAN_SPEED=2000

[gcode_macro CLEAN_NOZZLE_GENTLE]
description: Gentle nozzle clean (slow speed, good for delicate nozzles)
gcode:
    CLEAN_NOZZLE PASSES=3 CLEAN_SPEED=1500 RETRACT=true PRIME=true