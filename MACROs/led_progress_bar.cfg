#####################################################################
#   LED PROGRESS BAR - Print progress visualization
#####################################################################

[gcode_macro LED_PROGRESS_BAR]
description: Update LED strip to show print progress (red fills with green from both ends)
# How it works: All LEDs start red, green fills in from both bottom corners toward the back
# 0% = all red, 50% = green bars meet in middle, 100% = all green + celebration flash
# =============================================================================
# CONFIGURATION VARIABLES
# =============================================================================
variable_total_leds: 50                 # Total number of LEDs in strip
variable_progress_color_r: 0.0          # Progress fill color - GREEN
variable_progress_color_g: 1.0          # Progress fill color - GREEN
variable_progress_color_b: 0.0          # Progress fill color - GREEN
variable_background_color_r: 1.0        # Unfilled area color - RED
variable_background_color_g: 0.0        # Unfilled area color - RED
variable_background_color_b: 0.0        # Unfilled area color - RED
variable_complete_color_r: 1.0          # Completion flash color - WHITE
variable_complete_color_g: 1.0          # Completion flash color - WHITE
variable_complete_color_b: 1.0          # Completion flash color - WHITE

gcode:
    # Get print progress (0-100%), default to 0 if not available
    {% set progress = (printer.display_status.progress|default(0)) * 100 %}
    {% set total_leds = printer["gcode_macro LED_PROGRESS_BAR"].total_leds|int %}
    
    # Calculate how many LEDs should be lit from each end
    {% set leds_per_side = (progress / 100 * total_leds / 2)|round(0)|int %}
    
    # Colors
    {% set prog_r = printer["gcode_macro LED_PROGRESS_BAR"].progress_color_r %}
    {% set prog_g = printer["gcode_macro LED_PROGRESS_BAR"].progress_color_g %}
    {% set prog_b = printer["gcode_macro LED_PROGRESS_BAR"].progress_color_b %}
    {% set bg_r = printer["gcode_macro LED_PROGRESS_BAR"].background_color_r %}
    {% set bg_g = printer["gcode_macro LED_PROGRESS_BAR"].background_color_g %}
    {% set bg_b = printer["gcode_macro LED_PROGRESS_BAR"].background_color_b %}
    
    {% if progress >= 100 %}
        # Print complete - flash all LEDs white then go all green
        SET_LED LED=daylight RED={printer["gcode_macro LED_PROGRESS_BAR"].complete_color_r} GREEN={printer["gcode_macro LED_PROGRESS_BAR"].complete_color_g} BLUE={printer["gcode_macro LED_PROGRESS_BAR"].complete_color_b}
    {% else %}
        # Set all LEDs to red first (unfilled state)
        SET_LED LED=daylight RED={bg_r} GREEN={bg_g} BLUE={bg_b}
        
        # Fill in green progress LEDs from start (bottom right)
        {% for i in range(leds_per_side) %}
            SET_LED LED=daylight INDEX={i + 1} RED={prog_r} GREEN={prog_g} BLUE={prog_b}
        {% endfor %}
        
        # Fill in green progress LEDs from end (bottom left) 
        {% for i in range(leds_per_side) %}
            SET_LED LED=daylight INDEX={total_leds - i} RED={prog_r} GREEN={prog_g} BLUE={prog_b}
        {% endfor %}
    {% endif %}

[gcode_macro LED_PROGRESS_START]
description: Start LED progress bar updates during print
gcode:
    SET_DISPLAY_TEXT MSG="Starting LED progress bar"
    # Initial progress bar setup
    LED_PROGRESS_BAR
    
[gcode_macro LED_PROGRESS_COMPLETE]
description: Completion celebration with LEDs
gcode:
    SET_DISPLAY_TEXT MSG="Print complete! Celebration time!"
    
    # Flash sequence for completion
    {% for i in range(3) %}
        SET_LED LED=daylight RED=1.0 GREEN=1.0 BLUE=1.0  # White flash
        G4 P300
        SET_LED LED=daylight RED=0.0 GREEN=1.0 BLUE=0.0  # Green completion
        G4 P300
    {% endfor %}
    
    # Final state - all green for success
    SET_LED LED=daylight RED=0.0 GREEN=1.0 BLUE=0.0
    G4 P2000
    
    # Back to idle
    LIGHTS_IDLE

[gcode_macro LED_PROGRESS_TEST]
description: Test the progress bar effect with different percentages
gcode:
    SET_DISPLAY_TEXT MSG="Testing progress bar effect"
    
    # Test different progress levels
    {% set test_values = [10, 25, 50, 75, 90, 100] %}
    
    {% for progress in test_values %}
        SET_DISPLAY_TEXT MSG="Testing {progress}% progress"
        
        # Manually set the progress for testing
        {% set total_leds = printer["gcode_macro LED_PROGRESS_BAR"].total_leds|int %}
        {% set leds_per_side = (progress / 100 * total_leds / 2)|round(0)|int %}
        
        # Set all LEDs to red first (unfilled state)
        SET_LED LED=daylight RED=1.0 GREEN=0.0 BLUE=0.0
        
        {% if progress >= 100 %}
            # Complete - all green
            SET_LED LED=daylight RED=0.0 GREEN=1.0 BLUE=0.0
        {% else %}
            # Fill in green progress LEDs from start
            {% for i in range(leds_per_side) %}
                SET_LED LED=daylight INDEX={i + 1} RED=0.0 GREEN=1.0 BLUE=0.0
            {% endfor %}
            
            # Fill in green progress LEDs from end
            {% for i in range(leds_per_side) %}
                SET_LED LED=daylight INDEX={total_leds - i} RED=0.0 GREEN=1.0 BLUE=0.0
            {% endfor %}
        {% endif %}
        
        G4 P2000  # Wait 2 seconds to see the effect
    {% endfor %}
    
    SET_DISPLAY_TEXT MSG="Progress bar test complete"
    LIGHTS_IDLE

#####################################################################
#   INTEGRATION MACROS - Add these to your existing print macros
#####################################################################

[gcode_macro _PROGRESS_BAR_PRINT_START]
description: Add this to your PRINT_START macro
gcode:
    LED_PROGRESS_START

[gcode_macro _PROGRESS_BAR_PRINT_END] 
description: Add this to your PRINT_END macro
gcode:
    LED_PROGRESS_COMPLETE

#####################################################################
#   PERIODIC UPDATE - Automatic progress bar updates during printing
#####################################################################

[delayed_gcode LED_PROGRESS_UPDATE]
initial_duration: 0
gcode:
    {% if printer.print_stats.state == "printing" %}
        LED_PROGRESS_BAR
        UPDATE_DELAYED_GCODE ID=LED_PROGRESS_UPDATE DURATION=30  # Update every 30 seconds
    {% endif %}

[gcode_macro LED_PROGRESS_START_UPDATES]
description: Start automatic progress bar updates
gcode:
    UPDATE_DELAYED_GCODE ID=LED_PROGRESS_UPDATE DURATION=1

[gcode_macro LED_PROGRESS_STOP_UPDATES]
description: Stop automatic progress bar updates
gcode:
    UPDATE_DELAYED_GCODE ID=LED_PROGRESS_UPDATE DURATION=0