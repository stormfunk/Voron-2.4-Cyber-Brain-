#####################################################################
#   LED PROGRESS BAR - Print progress visualization
#####################################################################

[gcode_macro LED_PROGRESS_BAR]
description: Update LED strip to show print progress (red fills with green from both ends)
# How it works: All LEDs start red, green fills in from both bottom corners toward the back
# 0% = all red, 50% = green bars meet in middle, 100% = all green + celebration flash
# =============================================================================
# CONFIGURATION VARIABLES
# =============================================================================
variable_total_leds: 50                 # Total number of LEDs in strip
variable_progress_color_r: 0.0          # Progress fill color - GREEN
variable_progress_color_g: 1.0          # Progress fill color - GREEN
variable_progress_color_b: 0.0          # Progress fill color - GREEN
variable_background_color_r: 1.0        # Unfilled area color - RED
variable_background_color_g: 0.0        # Unfilled area color - RED
variable_background_color_b: 0.0        # Unfilled area color - RED
variable_complete_color_r: 1.0          # Completion flash color - WHITE
variable_complete_color_g: 1.0          # Completion flash color - WHITE
variable_complete_color_b: 1.0          # Completion flash color - WHITE

gcode:
    # Get print progress (0-100%), default to 0 if not available
    {% set progress = (printer.display_status.progress|default(0)) * 100 %}
    {% set total_leds = printer["gcode_macro LED_PROGRESS_BAR"].total_leds|int %}
    
    # Calculate how many LEDs should be lit from each end
    {% set leds_per_side = (progress / 100 * total_leds / 2)|round(0)|int %}
    
    # Colors
    {% set prog_r = printer["gcode_macro LED_PROGRESS_BAR"].progress_color_r %}
    {% set prog_g = printer["gcode_macro LED_PROGRESS_BAR"].progress_color_g %}
    {% set prog_b = printer["gcode_macro LED_PROGRESS_BAR"].progress_color_b %}
    {% set bg_r = printer["gcode_macro LED_PROGRESS_BAR"].background_color_r %}
    {% set bg_g = printer["gcode_macro LED_PROGRESS_BAR"].background_color_g %}
    {% set bg_b = printer["gcode_macro LED_PROGRESS_BAR"].background_color_b %}
    
    {% if progress >= 100 %}
        # Print complete - flash all LEDs white then go all green
        SET_LED LED=daylight RED={printer["gcode_macro LED_PROGRESS_BAR"].complete_color_r} GREEN={printer["gcode_macro LED_PROGRESS_BAR"].complete_color_g} BLUE={printer["gcode_macro LED_PROGRESS_BAR"].complete_color_b}
    {% else %}
        # Set all LEDs to red first (unfilled state)
        SET_LED LED=daylight RED={bg_r} GREEN={bg_g} BLUE={bg_b}
        
        # Fill in green progress LEDs from start (bottom right)
        {% for i in range(leds_per_side) %}
            SET_LED LED=daylight INDEX={i + 1} RED={prog_r} GREEN={prog_g} BLUE={prog_b}
        {% endfor %}
        
        # Fill in green progress LEDs from end (bottom left) 
        {% for i in range(leds_per_side) %}
            SET_LED LED=daylight INDEX={total_leds - i} RED={prog_r} GREEN={prog_g} BLUE={prog_b}
        {% endfor %}
    {% endif %}

[gcode_macro LED_PROGRESS_START]
description: Start LED progress bar updates during print
gcode:
    SET_DISPLAY_TEXT MSG="Starting LED progress bar"
    # Initial progress bar setup
    LED_PROGRESS_BAR
    
[gcode_macro LED_PROGRESS_COMPLETE]
description: Completion celebration with LEDs
gcode:
    SET_DISPLAY_TEXT MSG="Print complete! Celebration time!"
    
    # Flash sequence for completion
    {% for i in range(3) %}
        SET_LED LED=daylight RED=1.0 GREEN=1.0 BLUE=1.0  # White flash
        G4 P300
        SET_LED LED=daylight RED=0.0 GREEN=1.0 BLUE=0.0  # Green completion
        G4 P300
    {% endfor %}
    
    # Final state - all green for success
    SET_LED LED=daylight RED=0.0 GREEN=1.0 BLUE=0.0
    G4 P2000
    
    # Back to idle
    LIGHTS_IDLE

[gcode_macro LED_PROGRESS_TEST]
description: Test the progress bar effect with different percentages
gcode:
    SET_DISPLAY_TEXT MSG="Testing progress bar effect"
    
    # Test different progress levels
    {% set test_values = [10, 25, 50, 75, 90, 100] %}
    
    {% for progress in test_values %}
        SET_DISPLAY_TEXT MSG="Testing {progress}% progress"
        
        # Manually set the progress for testing
        {% set total_leds = printer["gcode_macro LED_PROGRESS_BAR"].total_leds|int %}
        {% set leds_per_side = (progress / 100 * total_leds / 2)|round(0)|int %}
        
        # Set all LEDs to red first (unfilled state)
        SET_LED LED=daylight RED=1.0 GREEN=0.0 BLUE=0.0
        
        {% if progress >= 100 %}
            # Complete - all green
            SET_LED LED=daylight RED=0.0 GREEN=1.0 BLUE=0.0
        {% else %}
            # Fill in green progress LEDs from start
            {% for i in range(leds_per_side) %}
                SET_LED LED=daylight INDEX={i + 1} RED=0.0 GREEN=1.0 BLUE=0.0
            {% endfor %}
            
            # Fill in green progress LEDs from end
            {% for i in range(leds_per_side) %}
                SET_LED LED=daylight INDEX={total_leds - i} RED=0.0 GREEN=1.0 BLUE=0.0
            {% endfor %}
        {% endif %}
        
        G4 P2000  # Wait 2 seconds to see the effect
    {% endfor %}
    
    SET_DISPLAY_TEXT MSG="Progress bar test complete"
    LIGHTS_IDLE

#####################################################################
#   INTEGRATION MACROS - Add these to your existing print macros
#####################################################################

[gcode_macro _PROGRESS_BAR_PRINT_START]
description: Add this to your PRINT_START macro
gcode:
    LED_PROGRESS_START

[gcode_macro _PROGRESS_BAR_PRINT_END] 
description: Add this to your PRINT_END macro
gcode:
    LED_PROGRESS_COMPLETE

#####################################################################
#   PERIODIC UPDATE - Automatic progress bar updates during printing
#####################################################################

[delayed_gcode LED_PROGRESS_UPDATE]
initial_duration: 0
gcode:
    {% if printer.print_stats.state == "printing" %}
        LED_PROGRESS_BAR
        UPDATE_DELAYED_GCODE ID=LED_PROGRESS_UPDATE DURATION=30  # Update every 30 seconds
    {% endif %}

[gcode_macro LED_PROGRESS_START_UPDATES]
description: Start automatic progress bar updates
gcode:
    UPDATE_DELAYED_GCODE ID=LED_PROGRESS_UPDATE DURATION=1

[gcode_macro LED_PROGRESS_STOP_UPDATES]
description: Stop automatic progress bar updates
gcode:
    UPDATE_DELAYED_GCODE ID=LED_PROGRESS_UPDATE DURATION=0

#####################################################################
#   HEATING PROGRESS BAR - Temperature visualization
#####################################################################

[gcode_macro LED_HEATING_PROGRESS]
description: Show heating progress - right side bed temp, left side extruder temp
# Right side (LEDs 1-25): Bed heating progress (blue → yellow → orange → red)
# Left side (LEDs 26-50): Extruder heating progress (blue → yellow → orange → red)
# Color progression: 0% = blue, 25% = yellow, 50% = orange, 75%+ = red
variable_total_leds: 50
gcode:
    {% set total_leds = printer["gcode_macro LED_HEATING_PROGRESS"].total_leds|int %}
    {% set leds_per_side = (total_leds / 2)|int %}

    # Get current and target temperatures
    {% set bed_current = printer.heater_bed.temperature|float %}
    {% set bed_target = printer.heater_bed.target|float %}
    {% set extruder_current = printer.extruder.temperature|float %}
    {% set extruder_target = printer.extruder.target|float %}

    # Calculate heating progress (0-100%)
    {% set bed_progress = 0.0 %}
    {% if bed_target > 0 %}
        {% set bed_progress = (((bed_current / bed_target) * 100)|float)|min(100.0)|max(0.0) %}
    {% endif %}

    {% set extruder_progress = 0.0 %}
    {% if extruder_target > 0 %}
        {% set extruder_progress = (((extruder_current / extruder_target) * 100)|float)|min(100.0)|max(0.0) %}
    {% endif %}

    # Calculate number of heated LEDs per side - ensure integers for range()
    {% set bed_heated_leds = (((bed_progress / 100.0) * leds_per_side)|round(0, 'floor')|int)|min(leds_per_side)|max(0) %}
    {% set extruder_heated_leds = (((extruder_progress / 100.0) * leds_per_side)|round(0, 'floor')|int)|min(leds_per_side)|max(0) %}

    # RIGHT SIDE - BED HEATING (LEDs 1-25)
    {% for i in range(leds_per_side) %}
        {% if i < bed_heated_leds %}
            # Heated portion - color based on progress percentage
            {% if bed_progress < 25 %}
                # 0-25%: Yellow (transition from blue)
                SET_LED LED=daylight INDEX={i + 1} RED=1.0 GREEN=1.0 BLUE=0.0
            {% elif bed_progress < 50 %}
                # 25-50%: Orange
                SET_LED LED=daylight INDEX={i + 1} RED=1.0 GREEN=0.5 BLUE=0.0
            {% else %}
                # 50-100%: Red
                SET_LED LED=daylight INDEX={i + 1} RED=1.0 GREEN=0.0 BLUE=0.0
            {% endif %}
        {% else %}
            # Unheated portion - Blue
            SET_LED LED=daylight INDEX={i + 1} RED=0.0 GREEN=0.0 BLUE=1.0
        {% endif %}
    {% endfor %}

    # LEFT SIDE - EXTRUDER HEATING (LEDs 26-50)
    {% for i in range(leds_per_side) %}
        {% set led_index = leds_per_side + i + 1 %}
        {% if i < extruder_heated_leds %}
            # Heated portion - color based on progress percentage
            {% if extruder_progress < 25 %}
                # 0-25%: Yellow (transition from blue)
                SET_LED LED=daylight INDEX={led_index} RED=1.0 GREEN=1.0 BLUE=0.0
            {% elif extruder_progress < 50 %}
                # 25-50%: Orange
                SET_LED LED=daylight INDEX={led_index} RED=1.0 GREEN=0.5 BLUE=0.0
            {% else %}
                # 50-100%: Red
                SET_LED LED=daylight INDEX={led_index} RED=1.0 GREEN=0.0 BLUE=0.0
            {% endif %}
        {% else %}
            # Unheated portion - Blue
            SET_LED LED=daylight INDEX={led_index} RED=0.0 GREEN=0.0 BLUE=1.0
        {% endif %}
    {% endfor %}

[gcode_macro LED_HEATING_START_UPDATES]
description: Start automatic heating progress updates
gcode:
    UPDATE_DELAYED_GCODE ID=LED_HEATING_UPDATE DURATION=1

[gcode_macro LED_HEATING_STOP_UPDATES]
description: Stop automatic heating progress updates
gcode:
    UPDATE_DELAYED_GCODE ID=LED_HEATING_UPDATE DURATION=0

[delayed_gcode LED_HEATING_UPDATE]
initial_duration: 0
gcode:
    # Only update if we're heating (either bed or extruder has a target)
    {% if printer.heater_bed.target > 0 or printer.extruder.target > 0 %}
        LED_HEATING_PROGRESS
        UPDATE_DELAYED_GCODE ID=LED_HEATING_UPDATE DURATION=2  # Update every 2 seconds
    {% endif %}